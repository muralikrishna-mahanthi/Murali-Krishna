{% liquid
  assign grid_id = 'product-grid-popup-' | append: section.id
%}

<section id="{{ grid_id }}" class="pgp">
  <div class="pgp__container">
    {% if section.settings.heading != blank %}
      <h2 class="pgp__heading">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="pgp__grid">
  {% assign rendered_count = 0 %}

  {% for block in section.blocks limit: 6 %}
    {% assign p = block.settings.product %}
    {% if p != blank %}
      {% assign card_id = grid_id | append: '-manual-' | append: block.id %}
      <article class="pgp__item" {{ block.shopify_attributes }}>
        <button class="pgp__trigger js-pgp-open" type="button" data-card-id="{{ card_id }}" aria-label="Open {{ p.title | escape }}">
          {% if p.featured_image %}
            <img
              class="pgp__image"
              src="{{ p.featured_image | image_url: width: 900 }}"
              alt="{{ p.featured_image.alt | default: p.title | escape }}"
              loading="lazy"
              width="{{ p.featured_image.width }}"
              height="{{ p.featured_image.height }}"
            >
          {% endif %}
          <span class="pgp__plus" aria-hidden="true">+</span>
        </button>
        <script type="application/json" class="js-pgp-product" data-card-id="{{ card_id }}">{{ p | json }}</script>
      </article>
      {% assign rendered_count = rendered_count | plus: 1 %}
    {% endif %}
  {% endfor %}
</div>

  </div>

  <div class="pgp-modal js-pgp-modal" hidden>
    <button class="pgp-modal__backdrop js-pgp-close" type="button" aria-label="Close popup"></button>
    <div class="pgp-modal__dialog" role="dialog" aria-modal="true" aria-label="Product quick view">
      <button class="pgp-modal__close js-pgp-close" type="button" aria-label="Close">×</button>

      <div class="pgp-modal__head">
        <img class="pgp-modal__image js-pgp-image" src="" alt="" width="" height="">
        <div>
          <h3 class="pgp-modal__title js-pgp-title"></h3>
          <p class="pgp-modal__price js-pgp-price"></p>
          <p class="pgp-modal__desc js-pgp-desc"></p>
        </div>
      </div>

      <div class="pgp-modal__options js-pgp-options"></div>

      <button class="pgp-modal__add js-pgp-add" type="button">Add to cart</button>
    </div>
  </div>
</section>

<div class="pgp-modal js-pgp-modal" hidden>
  <button class="pgp-modal__backdrop js-pgp-close" type="button" aria-label="Close"></button>

  <div class="pgp-modal__dialog" role="dialog" aria-modal="true" aria-label="Product quick view">
    <button class="pgp-modal__close js-pgp-close" type="button" aria-label="Close">×</button>

    <div class="pgp-modal__head">
      <img class="pgp-modal__image js-pgp-image" src="" alt="" width="" height="">
      <div>
        <h3 class="pgp-modal__title js-pgp-title"></h3>
        <p class="pgp-modal__price js-pgp-price"></p>
        <p class="pgp-modal__desc js-pgp-desc"></p>
      </div>
    </div>

    <div class="pgp-modal__variants js-pgp-variants"></div>

    <button class="pgp-modal__add js-pgp-add" type="button">Add to cart</button>
  </div>
</div>


<style>

  #{{ grid_id }} .pgp__grid:empty {
  display: none;
}

  #{{ grid_id }}.pgp {
    background: #e9e9e9;
    padding: 48px 0;
  }

  #{{ grid_id }} .pgp__container {
    width: min(1240px, calc(100% - 48px));
    margin: 0 auto;
  }

  #{{ grid_id }} .pgp__heading {
    margin: 0 0 22px;
    font-size: clamp(34px, 3.2vw, 56px);
    line-height: 1.1;
    font-weight: 400;
    color: #101010;
  }

  #{{ grid_id }} .pgp__grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    grid-template-rows: repeat(2, auto);
    gap: 14px;
  }

  #{{ grid_id }} .pgp__item {
    overflow: hidden;
  }

  #{{ grid_id }} .pgp__trigger {
    position: relative;
    display: block;
    width: 100%;
    border: 0;
    padding: 0;
    background: transparent;
    cursor: pointer;
  }

  #{{ grid_id }} .pgp__trigger--disabled {
    pointer-events: none;
    cursor: default;
  }

  #{{ grid_id }} .pgp__image {
    display: block;
    width: 100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
  }

  #{{ grid_id }} .pgp__plus {
    position: absolute;
    top: 50%;
    left: 62%;
    transform: translate(-50%, -50%);
    width: 34px;
    height: 34px;
    border-radius: 999px;
    background: #f2f2f2;
    color: #111;
    display: grid;
    place-items: center;
    font-size: 24px;
    line-height: 1;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.18);
    pointer-events: none;
  }

  #{{ grid_id }} .pgp-modal[hidden] {
    display: none;
  }

  #{{ grid_id }} .pgp-modal {
    position: fixed;
    inset: 0;
    z-index: 100;
  }

  #{{ grid_id }} .pgp-modal__backdrop {
    position: absolute;
    inset: 0;
    border: 0;
    background: rgba(0, 0, 0, 0.35);
    cursor: pointer;
  }

  #{{ grid_id }} .pgp-modal__dialog {
    position: relative;
    z-index: 1;
    width: min(92vw, 540px);
    max-height: calc(100vh - 40px);
    overflow: auto;
    margin: 20px auto;
    background: #fff;
    border: 1px solid #d0d0d0;
    padding: 22px;
    box-shadow: 0 10px 36px rgba(0, 0, 0, 0.22);
  }

  #{{ grid_id }} .pgp-modal__close {
    position: absolute;
    top: 8px;
    right: 10px;
    border: 0;
    background: transparent;
    font-size: 34px;
    line-height: 1;
    cursor: pointer;
  }

  #{{ grid_id }} .pgp-modal__head {
    display: grid;
    grid-template-columns: 140px 1fr;
    gap: 14px;
  }

  #{{ grid_id }} .pgp-modal__image {
    width: 100%;
    aspect-ratio: 1 / 1.1;
    object-fit: cover;
    background: #f7f7f7;
  }

  #{{ grid_id }} .pgp-modal__title {
    margin: 0 0 8px;
    font-size: 30px;
    line-height: 1.1;
    font-weight: 400;
  }

  #{{ grid_id }} .pgp-modal__price {
    margin: 0 0 8px;
    font-size: 34px;
    line-height: 1.1;
  }

  #{{ grid_id }} .pgp-modal__desc {
    margin: 0;
    font-size: 21px;
    line-height: 1.3;
    color: #2b2b2b;
  }

  #{{ grid_id }} .pgp-modal__options {
    margin-top: 16px;
  }

  #{{ grid_id }} .pgp-option {
    margin-top: 14px;
  }

  #{{ grid_id }} .pgp-option__label {
    margin: 0 0 8px;
    font-size: 18px;
  }

  #{{ grid_id }} .pgp-option__values {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  #{{ grid_id }} .pgp-option__value {
    border: 1px solid #979797;
    background: #fff;
    min-height: 42px;
    padding: 8px 14px;
    font-size: 17px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  #{{ grid_id }} .pgp-option__value:hover {
    border-color: #111;
    background: #f4f4f4;
  }

  #{{ grid_id }} .pgp-option__value.is-active {
    border-color: #111;
    background: #111;
    color: #fff;
  }

  #{{ grid_id }} .pgp-modal__add {
    margin-top: 18px;
    width: 100%;
    min-height: 54px;
    border: 0;
    background: #000;
    color: #fff;
    font-size: 24px;
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  #{{ grid_id }} .pgp-modal__add:hover {
    opacity: 0.9;
  }

  #{{ grid_id }} .pgp-modal__add:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (max-width: 749px) {
    #{{ grid_id }}.pgp {
      padding: 28px 0;
    }

    #{{ grid_id }} .pgp__container {
      width: calc(100% - 24px);
    }

    #{{ grid_id }} .pgp__heading {
      font-size: clamp(28px, 8vw, 42px);
      margin-bottom: 14px;
    }

    #{{ grid_id }} .pgp__grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
      grid-template-rows: repeat(3, auto);
      gap: 10px;
    }

    #{{ grid_id }} .pgp__plus {
      width: 28px;
      height: 28px;
      font-size: 20px;
    }

    #{{ grid_id }} .pgp-modal__dialog {
      width: calc(100vw - 20px);
      margin: 10px auto;
      padding: 14px;
    }

    #{{ grid_id }} .pgp-modal__head {
      grid-template-columns: 96px 1fr;
      gap: 10px;
    }

    #{{ grid_id }} .pgp-modal__title {
      font-size: 22px;
    }

    #{{ grid_id }} .pgp-modal__price {
      font-size: 24px;
    }

    #{{ grid_id }} .pgp-modal__desc {
      font-size: 15px;
    }
  }



  .pgp-modal[hidden] { display: none; }
.pgp-modal { position: fixed; inset: 0; z-index: 90; }
.pgp-modal__backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); border: 0; }
.pgp-modal__dialog {
  position: relative;
  z-index: 1;
  width: min(92vw, 540px);
  margin: 24px auto;
  max-height: calc(100vh - 48px);
  overflow: auto;
  background: #fff;
  border: 1px solid #d8d8d8;
  padding: 20px;
}
.pgp-modal__close {
  position: absolute; top: 8px; right: 10px;
  border: 0; background: transparent; font-size: 32px; cursor: pointer;
}
.pgp-modal__head { display: grid; grid-template-columns: 120px 1fr; gap: 12px; }
.pgp-modal__image { width: 100%; aspect-ratio: 1/1.1; object-fit: cover; background: #f4f4f4; }
.pgp-modal__title { margin: 0 0 6px; font-size: 24px; font-weight: 400; }
.pgp-modal__price { margin: 0 0 8px; font-size: 28px; }
.pgp-modal__desc { margin: 0; font-size: 15px; color: #333; }

.pgp-modal__variants { margin-top: 14px; }
.pgp-opt { margin-top: 10px; }
.pgp-opt__label { margin: 0 0 6px; font-size: 14px; }
.pgp-opt__values { display: flex; flex-wrap: wrap; gap: 8px; }
.pgp-opt__btn {
  border: 1px solid #999; background: #fff; min-height: 38px;
  padding: 6px 12px; cursor: pointer; font-size: 14px;
}
.pgp-opt__btn:hover { border-color: #111; }
.pgp-opt__btn.is-active { background: #111; color: #fff; border-color: #111; }

.pgp-modal__add {
  margin-top: 16px; width: 100%; min-height: 48px;
  border: 0; background: #000; color: #fff; font-size: 18px; cursor: pointer;
}
.pgp-modal__add:disabled { opacity: .5; cursor: not-allowed; }

@media (max-width: 749px) {
  .pgp-modal__dialog { width: calc(100vw - 20px); margin: 10px auto; padding: 14px; }
  .pgp-modal__head { grid-template-columns: 90px 1fr; }
  .pgp-modal__title { font-size: 20px; }
  .pgp-modal__price { font-size: 22px; }
}

</style>


<script>
(function () {
  var section = document.getElementById('{{ grid_id }}');
  if (!section) return;

  var modal = section.querySelector('.js-pgp-modal');
  var openBtns = section.querySelectorAll('.js-pgp-open');
  var closeBtns = section.querySelectorAll('.js-pgp-close');
  var productEls = section.querySelectorAll('.js-pgp-product');

  var titleEl = section.querySelector('.js-pgp-title');
  var priceEl = section.querySelector('.js-pgp-price');
  var descEl = section.querySelector('.js-pgp-desc');
  var imageEl = section.querySelector('.js-pgp-image');
  var variantsWrap = section.querySelector('.js-pgp-variants');
  var addBtn = section.querySelector('.js-pgp-add');

  var productMap = {};
  var currentProduct = null;
  var selectedVariant = null;
  var selectedOptions = [];

  productEls.forEach(function (el) {
    try { productMap[el.dataset.cardId] = JSON.parse(el.textContent); } catch (e) {}
  });

  function money(cents) {
    if (window.Shopify && typeof window.Shopify.formatMoney === 'function') return window.Shopify.formatMoney(cents);
    return '$' + ((cents || 0) / 100).toFixed(2);
  }

  function stripHtml(html) {
    var div = document.createElement('div');
    div.innerHTML = html || '';
    return (div.textContent || '').trim();
  }

  function findVariant() {
    if (!currentProduct || !currentProduct.variants) return null;
    return currentProduct.variants.find(function (v) {
      return v.options.every(function (opt, i) { return selectedOptions[i] === opt; });
    }) || null;
  }

  function renderState() {
    if (!selectedVariant) {
      addBtn.disabled = true;
      addBtn.textContent = 'Unavailable';
      return;
    }
    priceEl.textContent = money(selectedVariant.price);
    addBtn.disabled = !selectedVariant.available;
    addBtn.textContent = selectedVariant.available ? 'Add to cart' : 'Sold out';

    var img = (selectedVariant.featured_image && selectedVariant.featured_image.src) ||
              (currentProduct.featured_image && currentProduct.featured_image.src) || '';
    imageEl.src = img;
    imageEl.alt = currentProduct.title || 'Product';
  }

  function renderOptions() {
    variantsWrap.innerHTML = '';
    if (!currentProduct || !currentProduct.options_with_values) return;

    currentProduct.options_with_values.forEach(function (opt, i) {
      var group = document.createElement('div');
      group.className = 'pgp-opt';

      var label = document.createElement('p');
      label.className = 'pgp-opt__label';
      label.textContent = opt.name;
      group.appendChild(label);

      var values = document.createElement('div');
      values.className = 'pgp-opt__values';

      (opt.values || []).forEach(function (value) {
        var b = document.createElement('button');
        b.type = 'button';
        b.className = 'pgp-opt__btn' + (selectedOptions[i] === value ? ' is-active' : '');
        b.textContent = value;
        b.addEventListener('click', function () {
          selectedOptions[i] = value;
          selectedVariant = findVariant();
          renderOptions();
          renderState();
        });
        values.appendChild(b);
      });

      group.appendChild(values);
      variantsWrap.appendChild(group);
    });
  }

  function openModal(cardId) {
    var product = productMap[cardId];
    if (!product) return;

    currentProduct = product;
    selectedVariant = (product.variants || []).find(function (v) { return v.available; }) || (product.variants || [])[0] || null;
    selectedOptions = selectedVariant && selectedVariant.options ? selectedVariant.options.slice() : [];

    titleEl.textContent = product.title || '';
    descEl.textContent = stripHtml(product.description).slice(0, 140);
    renderOptions();
    renderState();

    modal.hidden = false;
  }

  function closeModal() {
    modal.hidden = true;
    currentProduct = null;
    selectedVariant = null;
    selectedOptions = [];
  }

  openBtns.forEach(function (btn) {
    btn.addEventListener('click', function () { openModal(btn.dataset.cardId); });
  });

  closeBtns.forEach(function (btn) { btn.addEventListener('click', closeModal); });

  document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape' && !modal.hidden) closeModal();
  });

  addBtn.addEventListener('click', function () {
    if (!selectedVariant || !selectedVariant.id || addBtn.disabled) return;

    addBtn.disabled = true;
    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ id: selectedVariant.id, quantity: 1 })
    })
      .then(function (res) {
        if (!res.ok) throw new Error('add failed');
        return res.json();
      })
      .then(function () {
        window.location.href = '/cart';
      })
      .catch(function () {
        addBtn.disabled = false;
      });
  });
})();
</script>


{% schema %}
{
  "name": "Product Grid ",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Tisso vison in the wild"
    }
  ],
  "blocks": [
    {
      "type": "product_item",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select product"
        }
      ]
    }
  ],
    "presets": [
    {
      "name": "Product Grid"
    }
  ]
}
{% endschema %}